name: Build and Release

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        default: 'v0.0.0-test'

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.2'
          cache: true

      - name: Get dependencies
        run: |
          cd bma_core && dart pub get
          cd ../bma_desktop && flutter pub get

      - name: Build macOS (Universal)
        run: |
          cd bma_desktop
          flutter build macos --release

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Create DMG
        run: |
          cd bma_desktop
          create-dmg \
            --volname "BMA Desktop" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "BMA Desktop.app" 150 185 \
            --app-drop-link 450 185 \
            "BMA-Desktop-${{ steps.version.outputs.version }}-macos.dmg" \
            "build/macos/Build/Products/Release/BMA Desktop.app"

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: bma_desktop/BMA-Desktop-${{ steps.version.outputs.version }}-macos.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Artifact (for manual runs)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: BMA-Desktop-${{ steps.version.outputs.version }}-macos
          path: bma_desktop/BMA-Desktop-${{ steps.version.outputs.version }}-macos.dmg

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.2'
          cache: true

      - name: Get dependencies
        run: |
          cd bma_core && dart pub get
          cd ../bma_desktop && flutter pub get

      - name: Build Windows
        run: |
          cd bma_desktop
          flutter build windows --release

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Create ZIP
        run: |
          cd bma_desktop/build/windows/x64/runner/Release
          Compress-Archive -Path * -DestinationPath "../../../../../BMA-Desktop-${{ steps.version.outputs.version }}-windows.zip"

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: bma_desktop/BMA-Desktop-${{ steps.version.outputs.version }}-windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Artifact (for manual runs)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: BMA-Desktop-${{ steps.version.outputs.version }}-windows
          path: bma_desktop/BMA-Desktop-${{ steps.version.outputs.version }}-windows.zip

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build libgtk-3-dev libblkid-dev liblzma-dev libayatana-appindicator3-dev

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.2'
          cache: true

      - name: Get dependencies
        run: |
          cd bma_core && dart pub get
          cd ../bma_desktop && flutter pub get

      - name: Build Linux
        run: |
          cd bma_desktop
          flutter build linux --release

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Download appimagetool
        run: |
          wget -O appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool

      - name: Create AppImage
        run: |
          cd bma_desktop

          # Create AppDir structure
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/lib
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

          # Copy build output
          cp -r build/linux/x64/release/bundle/* AppDir/usr/bin/

          # Create desktop file
          cat > AppDir/usr/share/applications/bma-desktop.desktop << EOF
          [Desktop Entry]
          Name=BMA Desktop
          Exec=bma_desktop
          Icon=bma-desktop
          Type=Application
          Categories=AudioVideo;Audio;
          EOF

          # Copy desktop file to AppDir root (required by AppImage)
          cp AppDir/usr/share/applications/bma-desktop.desktop AppDir/

          # Copy icon (use existing asset or create placeholder)
          if [ -f "assets/app_icon.png" ]; then
            cp assets/app_icon.png AppDir/usr/share/icons/hicolor/256x256/apps/bma-desktop.png
            cp assets/app_icon.png AppDir/bma-desktop.png
          else
            # Create a simple placeholder icon if none exists
            convert -size 256x256 xc:navy AppDir/usr/share/icons/hicolor/256x256/apps/bma-desktop.png 2>/dev/null || true
            convert -size 256x256 xc:navy AppDir/bma-desktop.png 2>/dev/null || true
          fi

          # Create AppRun
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin:${PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${HERE}/usr/bin/lib:${LD_LIBRARY_PATH}"
          exec "${HERE}/usr/bin/bma_desktop" "$@"
          EOF
          chmod +x AppDir/AppRun

          # Build AppImage
          cd ..
          ARCH=x86_64 ./appimagetool bma_desktop/AppDir "bma_desktop/BMA-Desktop-${{ steps.version.outputs.version }}-linux.AppImage"

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: bma_desktop/BMA-Desktop-${{ steps.version.outputs.version }}-linux.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Artifact (for manual runs)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: BMA-Desktop-${{ steps.version.outputs.version }}-linux
          path: bma_desktop/BMA-Desktop-${{ steps.version.outputs.version }}-linux.AppImage
